# ArgoCD Application - DrawGuess Game Server
# íŒŒì¼ ìœ„ì¹˜: gitops/applications/drawguess-game.yaml
# Phase 1: ê°€ì¥ ê¸°ë³¸ì ì¸ GitOps êµ¬ì„±

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: drawguess-game
  namespace: argocd
  # ì¤‘ìš”: ArgoCDê°€ ì´ Applicationì„ ì‚­ì œí•  ë•Œ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë„ í•¨ê»˜ ì‚­ì œ
  finalizers:
    - resources-finalizer.argocd.argoproj.io

spec:
  # í”„ë¡œì íŠ¸ ì„¤ì • (default í”„ë¡œì íŠ¸ ì‚¬ìš©)
  project: default
  
  # ì†ŒìŠ¤ ì„¤ì • - Git ì €ì¥ì†Œ ì •ë³´
  source:
    # GitHub ì €ì¥ì†Œ URL (ì‹¤ì œ URLë¡œ ë³€ê²½ í•„ìš”!)
    repoURL: https://github.com/Hwara/DrawGuess.git
    
    # ë¸Œëœì¹˜ ë˜ëŠ” íƒœê·¸ (HEAD = ìµœì‹  ì»¤ë°‹)
    targetRevision: HEAD
    
    # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ë¡œ
    path: gitops/manifests/drawguess-game
  
  # ë°°í¬ ëŒ€ìƒ ì„¤ì •
  destination:
    # í´ëŸ¬ìŠ¤í„° URL (ìê¸° ìì‹  = ë¡œì»¬ í´ëŸ¬ìŠ¤í„°)
    server: https://kubernetes.default.svc
    
    # ë°°í¬í•  ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    namespace: default
  
  # ë™ê¸°í™” ì •ì±… - GitOpsì˜ í•µì‹¬!
  syncPolicy:
    # ìë™ ë™ê¸°í™” ì„¤ì • (Phase 1ì—ì„œëŠ” ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘)
    automated:
      # ìˆ˜ë™ ë™ê¸°í™”ë¡œ ì‹œì‘ (í•™ìŠµ ëª©ì )
      # prune: false     # ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ìë™ ì‚­ì œ ë¹„í™œì„±í™”
      # selfHeal: false  # ìë™ ë³µêµ¬ ë¹„í™œì„±í™”
    
    # ë™ê¸°í™” ì˜µì…˜
    syncOptions:
      # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìë™ ìƒì„± (defaultëŠ” ì´ë¯¸ ì¡´ì¬í•˜ë¯€ë¡œ false)
      - CreateNamespace=false
      
      # ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì •ì±…
      - PrunePropagationPolicy=foreground
      
      # ë§ˆì§€ë§‰ì— ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
      - PruneLast=true
      
      # ì°¨ì´ì ë§Œ ì ìš© (ì„±ëŠ¥ ìµœì í™”)
      - ApplyOutOfSyncOnly=true
    
    # ì¬ì‹œë„ ì •ì±…
    retry:
      limit: 5
      backoff:
        duration: 5s      # ì²« ì¬ì‹œë„ê¹Œì§€ 5ì´ˆ ëŒ€ê¸°
        factor: 2         # ë§¤ë²ˆ 2ë°°ì”© ì¦ê°€
        maxDuration: 3m   # ìµœëŒ€ 3ë¶„ ëŒ€ê¸°
  
  # ë¦¬ì†ŒìŠ¤ ìƒíƒœ ë¬´ì‹œ ì„¤ì • (ê³ ê¸‰ ê¸°ëŠ¥)
  ignoreDifferences:
    # Serviceì˜ clusterIPëŠ” ìë™ í• ë‹¹ë˜ë¯€ë¡œ ë¬´ì‹œ
    - group: ""
      kind: Service
      jsonPointers:
        - /spec/clusterIP
        - /metadata/resourceVersion
    
    # Deploymentì˜ ì¼ë¶€ ìë™ ìƒì„± í•„ë“œ ë¬´ì‹œ
    - group: apps
      kind: Deployment
      managedFieldsManagers:
        - kube-controller-manager
      jsonPointers:
        - /spec/replicas  # HPA ì‚¬ìš© ì‹œ replicas ì¶©ëŒ ë°©ì§€
  
  # ë³€ê²½ ì´ë ¥ ë³´ê´€ ê°œìˆ˜
  revisionHistoryLimit: 5

---
# ArgoCD Application ìƒíƒœ ì„¤ëª…:
# 
# ğŸ”„ OutOfSync: Gitì˜ ì›í•˜ëŠ” ìƒíƒœì™€ í´ëŸ¬ìŠ¤í„°ì˜ í˜„ì¬ ìƒíƒœê°€ ë‹¤ë¦„
# âœ… Synced: Gitê³¼ í´ëŸ¬ìŠ¤í„° ìƒíƒœê°€ ì¼ì¹˜í•¨
# ğŸŸ¢ Healthy: ëª¨ë“  ë¦¬ì†ŒìŠ¤ê°€ ì •ìƒ ì‘ë™ ì¤‘
# ğŸŸ¡ Progressing: ë°°í¬ ì§„í–‰ ì¤‘
# ğŸ”´ Degraded: ì¼ë¶€ ë¦¬ì†ŒìŠ¤ì— ë¬¸ì œ ë°œìƒ
# â“ Unknown: ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŒ
#
# Phase 1 í•™ìŠµ ëª©í‘œ:
# 1. ìˆ˜ë™ ë™ê¸°í™”ë¡œ GitOps ì›Œí¬í”Œë¡œ ì´í•´
# 2. OutOfSync â†’ Synced ìƒíƒœ ë³€í™” ê´€ì°°
# 3. Git Push â†’ ìë™ ê°ì§€ â†’ ìˆ˜ë™ ë™ê¸°í™” ì²´í—˜