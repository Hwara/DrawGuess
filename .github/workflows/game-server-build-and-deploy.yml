# .github/workflows/game-server-build-and-deploy.yml
name: ðŸŽ® Build and Deploy Game Server

on:
  push:
    branches: [main]
    paths: 
      - 'game-server/**'  # ê²Œìž„ ì„œë²„ ì½”ë“œ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
      - '.github/workflows/game-server-build-and-deploy.yml'  # ì›Œí¬í”Œë¡œ íŒŒì¼ ë³€ê²½ ì‹œì—ë„ ì‹¤í–‰
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Custom version tag (e.g., v3.1.3)'
        required: false
        default: 'auto'

env:
  REGISTRY: 172.30.1.64:32000
  IMAGE_NAME: drawguess/game-server

jobs:
  build-and-push:
    name: ðŸ”¨ Build Multi-Architecture Image
    runs-on: self-hosted  # ë¼ì¦ˆë² ë¦¬íŒŒì´ runner ì‚¬ìš©
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë²„ì „ íƒœê¹…ìš©)
      
      - name: ðŸ·ï¸ Generate Version Tag
        id: version
        run: |
          if [ "${{ github.event.inputs.version_tag }}" != "auto" ] && [ "${{ github.event.inputs.version_tag }}" != "" ]; then
            # ìˆ˜ë™ ìž…ë ¥ ë²„ì „ ì‚¬ìš©
            VERSION="${{ github.event.inputs.version_tag }}"
          else
            # ìžë™ ë²„ì „ ìƒì„±: v3.1.x í˜•íƒœë¡œ ì¦ê°€
            LAST_TAG=$(git tag -l "v*" | sort -V | tail -1)
            if [ -z "$LAST_TAG" ]; then
              VERSION="v3.1.3"  # ì²« ë²ˆì§¸ íƒœê·¸
            else
              # ë§ˆì§€ë§‰ ìˆ«ìž ì¦ê°€ (v3.1.2 -> v3.1.3)
              VERSION=$(echo $LAST_TAG | awk -F. '{$NF = $NF + 1; print}' OFS=.)
            fi
          fi
          
          echo "Generated version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: ðŸ”§ Verify Docker Buildx
        run: |
          # í˜„ìž¬ ì‚¬ìš© ì¤‘ì¸ builder í™•ì¸
          echo "Current buildx setup:"
          docker buildx ls
          docker buildx inspect multiarch-builder
          
          # multiarch-builder ì‚¬ìš© ì„¤ì •
          docker buildx use multiarch-builder
      
      - name: ðŸ—ï¸ Build and Push Multi-Architecture Image
        working-directory: ./game-server  # Dockerfileì´ ìžˆëŠ” ë””ë ‰í† ë¦¬
        run: |
          echo "ðŸ”¨ Building image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          
          # ë©€í‹° ì•„í‚¤í…ì²˜ ë¹Œë“œ ë° Push
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --push \
            --build-arg VERSION=${{ steps.version.outputs.version }} \
            --build-arg COMMIT_SHA=${{ steps.version.outputs.short_sha }} \
            .
          
          echo "âœ… Successfully built and pushed:"
          echo "   - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          echo "   - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
      
      - name: ðŸ“Š Build Summary
        run: |
          echo "## ðŸŽ® DrawGuess Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Built Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: \`linux/amd64\`, \`linux/arm64\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ steps.version.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Update GitOps manifest with new image tag" >> $GITHUB_STEP_SUMMARY
          echo "2. ArgoCD will automatically sync within 3 minutes" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor deployment at: http://172.30.1.105" >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… Successfully built: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"

  update-gitops:
    name: ðŸ“ Update GitOps Manifest
    needs: build-and-push
    runs-on: self-hosted
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ“ Update Deployment Image Tag
        run: |
          MANIFEST_FILE="gitops/manifests/drawguess-game/deployment.yaml"
          NEW_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}"
          NEW_VERSION="${{ needs.build-and-push.outputs.version }}"
          
          echo "ðŸ“ Updating $MANIFEST_FILE"
          echo "ðŸ”„ New image: $NEW_IMAGE"
          echo "ðŸ·ï¸ New version: $NEW_VERSION"
          
          # yqë¥¼ ì‚¬ìš©í•´ì„œ ì´ë¯¸ì§€ íƒœê·¸ì™€ ë²„ì „ ë¼ë²¨ ì—…ë°ì´íŠ¸
          yq eval '.spec.template.spec.containers[0].image = "'$NEW_IMAGE'"' -i $MANIFEST_FILE
          yq eval '.metadata.labels.version = "'$NEW_VERSION'"' -i $MANIFEST_FILE  
          yq eval '.spec.template.metadata.labels.version = "'$NEW_VERSION'"' -i $MANIFEST_FILE
          
          # ë³€ê²½ ì‚¬í•­ í™•ì¸
          echo ""
          echo "âœ… Updated deployment.yaml:"
          echo "ðŸ“¦ Image: $(yq eval '.spec.template.spec.containers[0].image' $MANIFEST_FILE)"
          echo "ðŸ·ï¸ Metadata version: $(yq eval '.metadata.labels.version' $MANIFEST_FILE)"  
          echo "ðŸ·ï¸ Template version: $(yq eval '.spec.template.metadata.labels.version' $MANIFEST_FILE)"
      
      - name: ðŸš€ Commit and Push GitOps Changes
        run: |
          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ë³€ê²½ ì‚¬í•­ í™•ì¸
          if git diff --quiet; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi
          
          # ë³€ê²½ ì‚¬í•­ ì»¤ë°‹
          git add gitops/manifests/drawguess-game/deployment.yaml
          git commit -m "ðŸš€ Update game server image to ${{ needs.build-and-push.outputs.version }}

          Auto-generated by CI/CD pipeline
          
          - Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}
          - Commit: ${{ needs.build-and-push.outputs.short_sha }}
          - Trigger: ArgoCD will sync within 3 minutes"
          
          # í‘¸ì‹œ
          git push origin main
          
          echo "âœ… Successfully updated GitOps manifest"
      
      - name: ðŸ“Š GitOps Update Summary
        run: |
          echo "## ðŸš€ GitOps Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Updated Manifest" >> $GITHUB_STEP_SUMMARY
          echo "- **File**: \`gitops/manifests/drawguess-game/deployment.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- **New Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Next Steps (Automatic)" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… ArgoCD detects Git changes (within 3 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ”„ Kubernetes deployment rollout starts" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸŽ® New game server version goes live" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ“Š Monitor at: http://172.30.1.105" >> $GITHUB_STEP_SUMMARY