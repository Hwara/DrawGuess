# .github/workflows/game-server-build-and-deploy.yml
name: ğŸ® Build and Deploy Game Server

on:
  push:
    branches: [main]
    paths: 
      - 'game-server/**'  # ê²Œì„ ì„œë²„ ì½”ë“œ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
      - '.github/workflows/game-server-build-and-deploy.yml'  # ì›Œí¬í”Œë¡œ íŒŒì¼ ë³€ê²½ ì‹œì—ë„ ì‹¤í–‰
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Custom version tag (e.g., v3.1.3)'
        required: false
        default: 'auto'

env:
  REGISTRY: 172.30.1.64:32000
  IMAGE_NAME: drawguess/game-server

jobs:
  build-and-push:
    name: ğŸ”¨ Build Multi-Architecture Image
    runs-on: self-hosted  # ë¼ì¦ˆë² ë¦¬íŒŒì´ runner ì‚¬ìš©
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë²„ì „ íƒœê¹…ìš©)
      
      - name: ğŸ·ï¸ Generate Version Tag
        id: version
        run: |
          if [ "${{ github.event.inputs.version_tag }}" != "auto" ] && [ "${{ github.event.inputs.version_tag }}" != "" ]; then
            # ìˆ˜ë™ ì…ë ¥ ë²„ì „ ì‚¬ìš©
            VERSION="${{ github.event.inputs.version_tag }}"
          else
            # ìë™ ë²„ì „ ìƒì„±: v3.1.x í˜•íƒœë¡œ ì¦ê°€
            LAST_TAG=$(git tag -l "v*" | sort -V | tail -1)
            if [ -z "$LAST_TAG" ]; then
              VERSION="v3.1.3"  # ì²« ë²ˆì§¸ íƒœê·¸
            else
              # ë§ˆì§€ë§‰ ìˆ«ì ì¦ê°€ (v3.1.2 -> v3.1.3)
              VERSION=$(echo $LAST_TAG | awk -F. '{$NF = $NF + 1; print}' OFS=.)
            fi
          fi
          
          echo "Generated version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: ğŸ”§ Verify Docker Buildx
        run: |
          # í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ builder í™•ì¸
          echo "Current buildx setup:"
          docker buildx ls
          docker buildx inspect multiarch-builder
          
          # multiarch-builder ì‚¬ìš© ì„¤ì •
          docker buildx use multiarch-builder
      
      - name: ğŸ—ï¸ Build and Push Multi-Architecture Image
        working-directory: ./game-server  # Dockerfileì´ ìˆëŠ” ë””ë ‰í† ë¦¬
        run: |
          echo "ğŸ”¨ Building image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          
          # ë©€í‹° ì•„í‚¤í…ì²˜ ë¹Œë“œ ë° Push
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --push \
            --build-arg VERSION=${{ steps.version.outputs.version }} \
            --build-arg COMMIT_SHA=${{ steps.version.outputs.short_sha }} \
            .
          
          echo "âœ… Successfully built and pushed:"
          echo "   - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          echo "   - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
      
      - name: ğŸ·ï¸ Create Git Tag
        run: |
          # Git íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}
          
          echo "ğŸ“Œ Created and pushed tag: ${{ steps.version.outputs.version }}"
      
      - name: ğŸ“Š Build Summary
        run: |
          echo "## ğŸ® DrawGuess Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Built Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: \`linux/amd64\`, \`linux/arm64\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ steps.version.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Update GitOps manifest with new image tag" >> $GITHUB_STEP_SUMMARY
          echo "2. ArgoCD will automatically sync within 3 minutes" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor deployment at: http://172.30.1.105" >> $GITHUB_STEP_SUMMARY

  # ì„ íƒì : GitOps ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìë™ ì—…ë°ì´íŠ¸ (Phase 4ì—ì„œ ì¶”ê°€)
  # update-gitops:
  #   name: ğŸ“ Update GitOps Manifest  
  #   needs: build-and-push
  #   runs-on: self-hosted
  #   steps:
  #     - name: Update Kubernetes Manifest
  #       run: echo "GitOps ìë™ ì—…ë°ì´íŠ¸ëŠ” Phase 4ì—ì„œ êµ¬í˜„"